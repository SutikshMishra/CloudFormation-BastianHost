version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.8
    commands:
      - echo "Installing AWS CLI..."
      - if command -v yum > /dev/null; then yum update -y && yum install -y aws-cli; fi
      - if command -v apt-get > /dev/null; then apt-get update && apt-get install -y awscli; fi
      - if command -v apk > /dev/null; then apk add --no-cache aws-cli; fi
      - aws --version  # Verify installation

  pre_build:
    commands:
      - echo "Listing available CloudFormation templates..."
      - ls -l Bastion-Host/Bastion-Test/

  build:
    commands:
      - echo "Validating and Deploying VPC..."
      - |
        echo "Validating VPC Template..."
        aws cloudformation validate-template --template-body file://Bastion-Host/Bastion-Test/VPC-Temp.yml || exit 1

        echo "Deploying VPC..."
        aws cloudformation deploy \
          --template-file Bastion-Host/Bastion-Test/VPC-Temp.yml \
          --stack-name VPCStack \
          --capabilities CAPABILITY_NAMED_IAM \
          --region us-east-1 || exit 1

        echo "VPC deployment complete."

      - echo "Validating and Deploying Tunnel Instance..."
      - |
        echo "Validating Tunnel Instance Template..."
        aws cloudformation validate-template --template-body file://Bastion-Host/Bastion-Test/Tunnel-Instance.yml || exit 1

        echo "Deploying Tunnel Instance..."
        aws cloudformation deploy \
          --template-file Bastion-Host/Bastion-Test/Tunnel-Instance.yml \
          --stack-name TunnelStack \
          --capabilities CAPABILITY_NAMED_IAM \
          --region us-east-1 || exit 1

        echo "Tunnel Instance deployment complete."

      - echo "Validating and Deploying Private Instance..."
      - |
        echo "Validating Private Instance Template..."
        aws cloudformation validate-template --template-body file://Bastion-Host/Bastion-Test/Private-Instance.yml || exit 1

        echo "Deploying Private Instance..."
        aws cloudformation deploy \
          --template-file Bastion-Host/Bastion-Test/Private-Instance.yml \
          --stack-name PrivateStack \
          --capabilities CAPABILITY_NAMED_IAM \
          --region us-east-1 || exit 1

        echo "Private Instance deployment complete."

  post_build:
    commands:
      - echo "Deployment completed successfully!"

artifacts:
  files:
    - '**/*'

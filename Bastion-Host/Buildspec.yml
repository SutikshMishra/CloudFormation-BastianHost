version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.8
    commands:
      - echo "Installing AWS CLI..."
      - if command -v yum > /dev/null; then yum update -y && yum install -y aws-cli; fi
      - if command -v apt-get > /dev/null; then apt-get update && apt-get install -y awscli; fi
      - if command -v apk > /dev/null; then apk add --no-cache aws-cli; fi
      - aws --version  # Verify installation

  pre_build:
    commands:
      - echo "Listing available CloudFormation templates..."
      - |
        if [ ! -d "Bastion-Host/Bastion-Test" ]; then
          echo "Error: Template directory Bastion-Host/Bastion-Test/ not found. Exiting."
          exit 1
        fi
      - ls -l Bastion-Host/Bastion-Test/

  build:
    commands:
      - echo "Validating VPC Template..."
      - |
        if ! aws cloudformation validate-template --template-body file://Bastion-Host/Bastion-Test/VPC-Temp.yml; then
          echo "Error: VPC template validation failed. Exiting."
          aws cloudformation validate-template --template-body file://Bastion-Host/Bastion-Test/VPC-Temp.yml --debug
          exit 1
        fi
      - echo "VPC Template validation successful."

      - echo "Deploying VPC..."
      - |
        if ! aws cloudformation deploy \
          --template-file Bastion-Host/Bastion-Test/VPC-Temp.yml \
          --stack-name VPCStack \
          --capabilities CAPABILITY_NAMED_IAM \
          --region us-east-1; then
          echo "Error: VPC deployment failed. Exiting."
          aws cloudformation describe-stack-events --stack-name VPCStack --region us-east-1
          exit 1
        fi
      - echo "VPC deployment complete."

  post_build:
    commands:
      - echo "Deployment completed successfully!"

artifacts:
  files:
    - '**/*'
